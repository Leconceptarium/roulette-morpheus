<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header nav {
            margin-top: 15px;
        }

        .header nav a {
            color: white;
            text-decoration: none;
            margin-right: 20px;
            padding: 8px 16px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            transition: background 0.3s;
        }

        .header nav a:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="tel"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .help-text {
            color: #888;
            font-size: 14px;
            margin-top: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .bulk-section {
            margin-top: 30px;
        }

        .example-csv {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            margin-top: 10px;
            white-space: pre;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .preview {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #667eea;
        }

        .preview-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí¨ Envoyer des SMS - <%= businessName %></h1>
        <nav>
            <a href="/?password=<%= adminPassword %>">üè† Accueil</a>
            <a href="/admin/stats?password=<%= adminPassword %>">üìä Statistiques</a>
            <a href="/admin/send-sms?password=<%= adminPassword %>">üí¨ Envoyer SMS</a>
        </nav>
    </div>

    <div class="container">
        <div class="alert alert-success" id="successAlert"></div>
        <div class="alert alert-error" id="errorAlert"></div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('single')">üì± SMS Unique</button>
                <button class="tab" onclick="switchTab('bulk')">üìã SMS en Masse</button>
            </div>

            <!-- Envoi unique -->
            <div id="single-tab" class="tab-content active">
                <h2>Envoyer un SMS unique</h2>
                <form id="singleSmsForm">
                    <div class="form-group">
                        <label for="customerName">Pr√©nom du client</label>
                        <input type="text" id="customerName" placeholder="Jean">
                        <div class="help-text">Le pr√©nom sera utilis√© dans le message (optionnel)</div>
                    </div>

                    <div class="form-group">
                        <label for="phoneNumber">Num√©ro de t√©l√©phone *</label>
                        <input type="tel" id="phoneNumber" placeholder="+33612345678 ou 0612345678" required>
                        <div class="help-text">Format : +33612345678 ou 0612345678</div>
                    </div>

                    <div class="preview">
                        <div class="preview-label">üì± Aper√ßu du SMS :</div>
                        <div id="smsPreview">
                            Bonjour [Pr√©nom], merci d'avoir visit√© Morpheus Experience ! üé≠‚ú®<br><br>
                            Nous esp√©rons que vous avez pass√© un moment magique dans notre escape game.<br><br>
                            Votre avis compte √©norm√©ment pour nous ! Pourriez-vous prendre 2 minutes pour partager votre exp√©rience sur Google ?<br><br>
                            üëâ [Lien personnalis√©]<br><br>
                            Merci infiniment !<br>
                            L'√©quipe Morpheus üîÆ
                        </div>
                    </div>

                    <button type="submit" class="btn" id="sendBtn">üì§ Envoyer le SMS</button>
                </form>
            </div>

            <!-- Envoi en masse -->
            <div id="bulk-tab" class="tab-content">
                <h2>Envoyer des SMS en masse</h2>
                
                <div class="form-group">
                    <label for="bulkData">Liste des clients (format CSV)</label>
                    <textarea id="bulkData" placeholder="Collez vos donn√©es ici..."></textarea>
                    <div class="help-text">Format : pr√©nom,t√©l√©phone (un client par ligne)</div>
                </div>

                <div class="example-csv">
Exemple :
Jean,0612345678
Marie,+33687654321
Pierre,0623456789</div>

                <button type="button" class="btn" onclick="sendBulkSMS()" id="bulkSendBtn">
                    üì§ Envoyer tous les SMS
                </button>
            </div>
        </div>
    </div>

    <script>
        const adminPassword = '<%= adminPassword %>';

        // Gestion des onglets
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }

        // Mise √† jour de l'aper√ßu du SMS
        document.getElementById('customerName').addEventListener('input', function() {
            updatePreview();
        });

        function updatePreview() {
            const name = document.getElementById('customerName').value || '[Pr√©nom]';
            const preview = document.getElementById('smsPreview');
            
            preview.innerHTML = `Bonjour ${name}, merci d'avoir visit√© Morpheus Experience ! üé≠‚ú®<br><br>
Nous esp√©rons que vous avez pass√© un moment magique dans notre escape game.<br><br>
Votre avis compte √©norm√©ment pour nous ! Pourriez-vous prendre 2 minutes pour partager votre exp√©rience sur Google ?<br><br>
üëâ [Lien personnalis√©]<br><br>
Merci infiniment !<br>
L'√©quipe Morpheus üîÆ`;
        }

        // Envoi d'un SMS unique
        document.getElementById('singleSmsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('phoneNumber').value;
            const btn = document.getElementById('sendBtn');
            
            btn.disabled = true;
            btn.textContent = 'üì§ Envoi en cours...';
            
            try {
                const response = await fetch('/api/send-review-request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customerName: name,
                        phone: phone
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', `‚úì SMS envoy√© avec succ√®s √† ${data.data.phone}`);
                    document.getElementById('singleSmsForm').reset();
                    updatePreview();
                } else {
                    showAlert('error', `‚ùå Erreur : ${data.error}`);
                }
            } catch (error) {
                showAlert('error', `‚ùå Erreur lors de l'envoi : ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì§ Envoyer le SMS';
            }
        });

        // Envoi en masse
        async function sendBulkSMS() {
            const bulkData = document.getElementById('bulkData').value.trim();
            
            if (!bulkData) {
                showAlert('error', 'Veuillez entrer des donn√©es');
                return;
            }
            
            // Parser les donn√©es CSV
            const lines = bulkData.split('\n').filter(line => line.trim());
            const customers = [];
            
            for (const line of lines) {
                const [name, phone] = line.split(',').map(s => s.trim());
                if (phone) {
                    customers.push({ name, phone });
                }
            }
            
            if (customers.length === 0) {
                showAlert('error', 'Aucun client valide trouv√©');
                return;
            }
            
            const btn = document.getElementById('bulkSendBtn');
            btn.disabled = true;
            btn.textContent = `üì§ Envoi en cours... (0/${customers.length})`;
            
            try {
                const response = await fetch('/api/send-bulk-review-requests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ customers })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', data.message);
                    document.getElementById('bulkData').value = '';
                } else {
                    showAlert('error', `‚ùå Erreur : ${data.error}`);
                }
            } catch (error) {
                showAlert('error', `‚ùå Erreur lors de l'envoi : ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì§ Envoyer tous les SMS';
            }
        }

        // Affichage des alertes
        function showAlert(type, message) {
            const alertId = type === 'success' ? 'successAlert' : 'errorAlert';
            const alert = document.getElementById(alertId);
            
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
            
            // Scroll vers le haut pour voir l'alerte
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
